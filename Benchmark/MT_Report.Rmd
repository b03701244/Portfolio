---
title: "Machine Tools Analysis"
output:
  html_document: default
  pdf_document: default
author: Hilary Lai
---

## Creating Dataset
* Merged ADI Revenue dataset with Taiwan's Machine Tools export and aligned time to ADI's Fiscal Month/Qtr

```{r, echo=T, include=T, warning=FALSE, message=F}
library(tidyverse)
library(readr)
library(rvest)
library(ggplot2)

DAR <- read_csv("DAR_Historic.csv")
DAR$Revenue <- gsub("[],\\)]", "",DAR$Revenue)
DAR$Revenue <- gsub("^\\(", "-",DAR$Revenue)
DAR$Revenue <- gsub("\\$", "",DAR$Revenue) %>% as.numeric()
DAR_grouped <-  DAR %>%
  group_by(Fiscal_Mth) %>%
  summarise(Revenue = sum(Revenue))

url <- "https://web02.mof.gov.tw/njswww/webMain.aspx?sys=220&ym=9001&ymt=11007&kind=21&type=1&funid=i9161&cycle=1&outmode=0&compmode=00&outkind=1&fld0=1&cod018=1&rdm=R159145"
data <- read_html(url) %>%
  html_nodes("table") %>% .[[2]]

table <- data %>% html_table()
table <- table[-1,]
colnames(table) <- c("Date", "Exports")
Sys.setlocale("LC_ALL","Chinese")
table <- table %>%
  separate(Date, c("CY", "CM"), "年 ") %>%
  mutate(CY = as.numeric(CY) + 1911)
table$CM <- gsub("月", "", table$CM) %>% as.numeric()
table$Exports <- gsub(",", "", table$Exports) %>% as.numeric()

#get fiscal month and quarter
table <- table %>%
  mutate(Calendar_Mth = CY*100+CM,
         Fiscal_Mth = ifelse(CM < 11, CY*100+CM+2,
         (CY+1)*100+CM-10),
         Exports = Exports*1000)
table <- table %>%
  mutate(FQ = Fiscal_Mth%/%100*10+(Fiscal_Mth%%100-1)%/%3+1)

summ <- DAR_grouped %>%
  left_join(table) %>%
  group_by(Fiscal_Mth, FQ) %>%
  summarise(Exports = sum(Exports), Revenue = sum(Revenue)) %>%
  gather("Type", "Value", Exports:Revenue) %>%
  na.omit()%>%
  ungroup()

#make month discreet
summ$Fiscal_Mth <- summ$Fiscal_Mth %>%
  ordered(levels = unique(summ$Fiscal_Mth))

plot.mth <- summ %>%
  ggplot(aes(x=factor(Fiscal_Mth), y=Value, group = Type, color = Type)) + 
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Fiscal_Mth")

qtr_data <- summ %>%
  dplyr::group_by(FQ, Type)%>%
  dplyr::summarise(Value = sum(Value)) %>%
  na.omit(.)
#make FQ discrete
qtr_data$FQ <- qtr_data$FQ %>%
  ordered(levels = unique(qtr_data$FQ))

plot.qtr <- qtr_data %>%
  ggplot(aes(x=FQ, y=Value, group = Type, color = Type)) + 
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Fiscal_Qtr")
```

## Table looks like this:

```{r table}
head(summ)
```

## Machine Tools Export vs. ADI DAR Revenue Plot

### 1. By Fiscal Month

```{r, include=T}
plot.mth
```

### 2. By Fiscal Quarter

```{r, include=T}
plot.qtr
```

## Alternative method: Growth % as value

```{r, include=T, warning=F, message=F}
change_summ <- summ %>%
  group_by(Type, Fiscal_Mth) %>%
  summarise(Value = sum(Value)) %>%
  arrange(desc(Fiscal_Mth), .by_group = TRUE) %>%
  mutate(Delta = (Value - lead(Value))/lead(Value)*100)
#before smoothing
bf_mth <- change_summ %>%
  ggplot(aes(x=factor(Fiscal_Mth), y=Delta, group = Type, color = Type)) + 
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Fiscal_Mth")

#calculate rm
change_summ$Delta_ra <- rollmean(change_summ$Delta,6, fill=NA)

change_summ2 <- change_summ %>%
  group_by(Fiscal_Mth, Type) %>%
  summarise(Delta_ra = mean(Delta_ra))%>%
  spread(Type, Delta_ra, fill = 0)

#after smoothing
af_mth <- change_summ2 %>%
  ggplot()+
  geom_line(aes(x=factor(Fiscal_Mth), y=Exports, group = 1, color = "Exports"), size=1) + 
  geom_line(aes(x=factor(Fiscal_Mth), y=Revenue, group = 1, color = "Revenue"), size=1) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Fiscal_Mth") +
  ylab("Change%")

af_mth_reg <- ggplot(change_summ2, aes(y=Exports, x=Revenue))+
  geom_point() +
  geom_smooth(method="lm")  +
  xlab("Export Change%") +
  ylab("Revenue Change%")

#by qtr
change_summ2 <- summ %>%
  group_by(Type, FQ) %>%
  summarise(Value = sum(Value)) %>%
  arrange(desc(FQ), .by_group = TRUE) %>%
  mutate(Delta = (Value - lead(Value))/lead(Value)*100)

#before smoothing
bf_qtr <- change_summ2 %>%
  ggplot(aes(x=factor(FQ), y=Delta, group = Type, color = Type)) + 
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("FQ")

#calculate rm mth
change_summ2$Delta_ra <- rollmean(change_summ2$Delta,6, fill=NA)

change_summ2 <- change_summ2 %>%
  na.omit() %>%
  group_by(FQ, Type) %>%
  dplyr::summarise(Delta_ra = mean(Delta_ra))

#after smoothing mth
af_qtr <- change_summ2 %>%
  ggplot(aes(x=factor(FQ), y=Delta_ra, group = Type, color = Type)) + 
  geom_line(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("FQ") +
  ylab("Change%")
```

### 1. Monthly Growth % Plot Before Rolling Mean Smoothing

```{r, include=T}
bf_mth
```

### 2. Quarterly Growth % Plot Before Rolling Mean

```{r, include=T}
bf_qtr
```

### 3. Monthly Growth % Plot After Rolling Mean

```{r, include=T}
af_mth
```

### 4. Quarterly Growth % Plot After Rolling Mean

```{r, include=T}
af_qtr
```

There seems to be correlation between the 2 variables. Let's do a linear regression test to check for significance.

### 4-1. Linear Regression

```{r lm, include=T, warning=F, message=F}

lm_change <- change_summ2 %>%
  spread(Type, Delta_ra) %>%
  .[,-1] %>%
  as.data.frame()

af_qtr_reg <- lm_change %>%
  ggplot(aes(x=Revenue, y=Exports)) + 
  geom_point(size = 1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  geom_smooth(method="lm") +
  xlab("Revenue Change %") +
  ylab("Exports Change %")

fit <- lm(lm_change$Exports~lm_change$Revenue)
summary(fit)
```

The regression plot would look like this:
```{r, include=T}
af_qtr_reg
```

### 5. Plotting by Each Segment
```{r, include=T, echo=F}
library(tidyverse)
library(readr)
library(rvest)
library(ggplot2)
library(zoo)

DAR <- read_csv("DAR_Historic.csv")
DAR$Revenue <- gsub("[],\\)]", "",DAR$Revenue)
DAR$Revenue <- gsub("^\\(", "-",DAR$Revenue)
DAR$Revenue <- gsub("\\$", "",DAR$Revenue) %>% as.numeric()

DAR <-  DAR %>%
  group_by(Fiscal_Mth, End_Mkt_Segment) %>%
  filter(End_Mkt_Segment %in% c("AEG", "ASD", "AUT", "COM", "CON", "DHC", "INS")) %>%
  summarise(Revenue = sum(Revenue)) %>%
  spread(End_Mkt_Segment,Revenue, fill = 0)

#get mt data
url <- "https://web02.mof.gov.tw/njswww/webMain.aspx?sys=220&ym=9001&ymt=11007&kind=21&type=1&funid=i9161&cycle=1&outmode=0&compmode=00&outkind=1&fld0=1&cod018=1&rdm=R159145"
data <- read_html(url) %>%
  html_nodes("table") %>% .[[2]]
table <- data %>% html_table()
table <- table[-1,]
colnames(table) <- c("Date", "MachineExports")
Sys.setlocale("LC_ALL","Chinese")
table <- table %>%
  separate(Date, c("CY", "CM"), "年 ") %>%
  mutate(CY = as.numeric(CY) + 1911)
table$CM <- gsub("月", "", table$CM) %>% as.numeric()
table$MachineExports <- gsub(",", "", table$MachineExports) %>% as.numeric()

#get fiscal month and quarter
table <- table %>%
  mutate(Calendar_Mth = CY*100+CM,
         Fiscal_Mth = ifelse(CM < 11, CY*100+CM+2,
                             (CY+1)*100+CM-10),
         MachineExports = MachineExports*1000)
table <- table %>%
  mutate(FQ = Fiscal_Mth%/%100*10+(Fiscal_Mth%%100-1)%/%3+1)
by_seg <- DAR %>%
  left_join(table) %>%
  group_by(FQ) %>%
  summarise_at(c(1:8,11), sum)

delta <- function(x){
  x <-( x - lag(x))/lag(x)*100
  x <- rollmean(x, 4, fill = NA)
}
seg_delta <- by_seg
seg_delta[,c(3:10)] <- lapply(by_seg[,c(3:10)], delta)
seg_delta <- seg_delta %>%
  gather(Type, Delta, AEG:MachineExports) %>% na.omit()

#by segment
seg_delta %>%
  ggplot(aes(x=factor(FQ), y=Delta, group = Type, color = Type)) + 
  geom_line(aes(size = Type)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("FQ") +
  ylab("Change%") +
  scale_size_manual(values = c(AEG=0.5, ASD=0.5, AUT=0.5, COM=0.5, CON=0.5, DHC=0.5, INS=0.5,MachineExports = 1.5))

summary(lm(seg_delta$Delta~seg_delta$FQ))

```